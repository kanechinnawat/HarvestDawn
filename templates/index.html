<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harvest Dawn - Elevation Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; color: #333; margin: 0; overflow: hidden; }
        .container { display: flex; flex-direction: column; height: 100vh; }
        .main-content { display: flex; flex: 1; position: relative; }
        .map-container { flex: 1; height: 100%; }
        #map { width: 100%; height: 100%; }

        /* Results panel */
        .results-panel {
            position: absolute; right: 0; top: 0; height: 100%;
            width: 450px; background: #fff; padding: 20px;
            box-sizing: border-box; overflow-y: auto;
            box-shadow: -4px 0 8px rgba(0,0,0,0.1);
            transition: transform 0.4s ease-in-out;
            transform: translateX(100%);
            z-index: 1000;
        }
        .results-panel.open { transform: translateX(0); }

        /* Toggle button */
        .toggle-btn {
            position: absolute;
            top: 20px;
            right: 460px;
            z-index: 1100;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px 0 0 4px;
            padding: 8px 14px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            font-size: 14px;
        }
        .toggle-btn:hover { background: #45a049; }

        /* Cards & text */
        .info-box {
            background-color: #e9f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .result-card {
            border: 1px solid #ddd;
            border-left: 5px solid #4CAF50;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .result-card.low-score { border-left-color: #e53935; background-color: #fdecea; }  /* ‡πÅ‡∏î‡∏á */
        .result-card.medium-score { border-left-color: #f4b400; background-color: #fff8e1; } /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á */
        .advice-box {
            background-color: #e3f2e9;
            border-radius: 5px;
            padding: 10px;
            font-size: 0.9em;
            margin-top: 8px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-content">
        <div class="map-container"><div id="map"></div></div>

        <button class="toggle-btn" id="toggleBtn">üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>

        <div class="results-panel" id="resultsPanel">
            {% if recommendations %}
                <h2>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
                <div class="info-box">
                    <div><strong>‡∏ä‡∏ô‡∏¥‡∏î‡∏î‡∏¥‡∏ô:</strong> {{ input_data.soil_type }}</div>
                    <div><strong>‡∏ù‡∏ô:</strong> {{ "%.0f"|format(input_data.avg_rainfall_mm) }} ‡∏°‡∏°.</div>
                    <div><strong>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥:</strong> {{ "%.0f"|format(input_data.avg_temp_celsius) }} ¬∞C</div>
                    <div><strong>‡∏•‡∏≤‡∏î‡∏ä‡∏±‡∏ô:</strong> {{ "%.0f"|format(input_data.slope_degree) }}¬∞</div>
                </div>

                {% for rec in recommendations %}
                    {% set cls = "" %}
                    {% if rec.suitability_score <= 2 %}
                        {% set cls = "low-score" %}
                    {% elif rec.suitability_score == 3 %}
                        {% set cls = "medium-score" %}
                    {% endif %}
                    <div class="result-card {{ cls }}">
                        <h3>{{ loop.index }}. {{ rec.crop_name }}</h3>
                        <p><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</strong> {{ rec.suitability_score }} / {{ rec.max_score }}</p>
                        <p><strong>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> {{ rec.market_trend }}</p>
                        <div class="advice-box">
                            <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</strong> {{ rec.advice }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <h3>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Harvest Dawn</h3>
                <p>1. ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</p>
                <p>2. ‡∏Å‡∏î ‚Äú‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
            {% endif %}
        </div>

        <div class="form-container" style="position:absolute; top:20px; left:50%; transform:translateX(-50%); z-index:1100;">
            <form action="/" method="POST" id="mapForm">
                <input type="hidden" name="polygon_coords" id="polygon_coords">
                <button type="submit" id="analyzeBtn" disabled>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</button>
            </form>
        </div>
    </div>
</div>

<!-- ‡∏ù‡∏±‡∏á‡∏Ñ‡πà‡∏≤ has_recommendations ‡∏î‡πâ‡∏ß‡∏¢ JSON ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á VS Code ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡πá‡∏ô JS -->
<script id="hasRecsData" type="application/json">{{ has_recommendations | tojson }}</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script>
const map = L.map('map').setView([13.75, 100.5], 6);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png');
L.control.layers({ "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏Å‡∏ï‡∏¥": osm, "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®": topo }).addTo(map);

/* ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà polyline ‡πÅ‡∏•‡∏∞ rectangle ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ */
const drawn = new L.FeatureGroup().addTo(map);
const drawControl = new L.Control.Draw({
    draw: {
        polyline: { shapeOptions: { weight: 3 } },
        rectangle: { shapeOptions: { weight: 2 } },
        polygon: false,
        circle: false,
        marker: false,
        circlemarker: false
    },
    edit: { featureGroup: drawn }
});
map.addControl(drawControl);

const analyzeBtn = document.getElementById('analyzeBtn');
const coordsInput = document.getElementById('polygon_coords');
map.on(L.Draw.Event.CREATED, e => {
    drawn.clearLayers();
    drawn.addLayer(e.layer);
    coordsInput.value = JSON.stringify(e.layer.toGeoJSON());
    analyzeBtn.disabled = false;
});

const resultsPanel = document.getElementById('resultsPanel');
const toggleBtn = document.getElementById('toggleBtn');
toggleBtn.onclick = () => {
    resultsPanel.classList.toggle('open');
    toggleBtn.textContent = resultsPanel.classList.contains('open') ? 'üîΩ ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå' : 'üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå';
};

/* ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å script JSON ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ VS Code ‡∏ü‡πâ‡∏≠‡∏á error */
const hasRecommendations = JSON.parse(document.getElementById('hasRecsData').textContent || 'false');
if (hasRecommendations) {
    resultsPanel.classList.add('open');
    toggleBtn.textContent = 'üîΩ ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå';
}
</script>
</body>
</html>
