<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harvest Dawn - Elevation Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        /* CSS ทั้งหมดเหมือนเดิม ไม่มีการเปลี่ยนแปลง */
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; color: #333; margin: 0; overflow: hidden; }
        .container { display: flex; flex-direction: column; height: 100vh; }
        .main-content { display: flex; flex: 1; position: relative; }
        .map-container { flex: 1; height: 100%; }
        #map { width: 100%; height: 100%; }
        .results-panel { position: absolute; right: 0; top: 0; height: 100%; width: 450px; background: #fff; padding: 20px; box-sizing: border-box; overflow-y: auto; box-shadow: -4px 0 8px rgba(0,0,0,0.1); transition: transform 0.4s ease-in-out; transform: translateX(100%); z-index: 1000; }
        .results-panel.open { transform: translateX(0); }
        .form-container { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1001; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        h1, h2, h3 { color: #2c5d3c; }
        .info-box { background-color: #e9f5e9; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .result-card { border: 1px solid #ddd; border-left: 5px solid #4CAF50; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #fafafa; }
        .result-card.low-score { border-left-color: #f4b400; }
        .reasons { color: #d9534f; font-size: 0.9em; }
        /* เพิ่มสไตล์สำหรับ Popup ของ Leaflet เล็กน้อย */
        .leaflet-popup-content-wrapper { border-radius: 5px; }
        .leaflet-popup-content { font-family: 'Sarabun', sans-serif; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="results-panel" id="resultsPanel">
                 {% if recommendations %}
                    <h2>ผลการวิเคราะห์</h2>
                    <p>สำหรับพื้นที่ที่คุณเลือก ระบบจำลองคุณลักษณะได้ดังนี้:</p>
                    <div class="info-box">
                        <div><strong>ชนิดดิน:</strong> {{ input_data.soil_type }}</div>
                        <div><strong>ปริมาณฝน:</strong> {{ "%.0f"|format(input_data.avg_rainfall_mm) }} มม./ปี</div>
                        <div><strong>อุณหภูมิ:</strong> {{ "%.0f"|format(input_data.avg_temp_celsius) }} °C</div>
                        <div><strong>ความลาดชัน:</strong> {{ "%.0f"|format(input_data.slope_degree) }}°</div>
                    </div>
                    {% for rec in recommendations %}
                    <div class="result-card {% if rec.suitability_score < 3 %}low-score{% endif %}">
                        <h3>{{ loop.index }}. {{ rec.crop_name }}</h3>
                        <p><strong>คะแนนความเหมาะสม:</strong> {{ rec.suitability_score }} / {{ rec.max_score }}</p>
                        <p><strong>แนวโน้มราคาตลาด:</strong> {{ rec.market_trend }}</p>
                        {% if rec.reasons_for_low_score %}
                            <p class="reasons"><strong>ข้อควรพิจารณา:</strong> {{ rec.reasons_for_low_score | join(', ') }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <h3>ยินดีต้อนรับสู่ Harvest Dawn</h3>
                    <p>ขั้นตอนการใช้งาน:</p>
                    <ol>
                        <li>ใช้เมนูมุมขวาบนเพื่อสลับมุมมองแผนที่ความสูง</li>
                        <li>คลิกบนแผนที่เพื่อดูค่าความสูง (จำลอง)</li>
                        <li>ใช้เครื่องมือวาดรูป (มุมซ้ายบน) เพื่อวาดขอบเขตพื้นที่</li>
                        <li>กดปุ่ม "วิเคราะห์พื้นที่" เพื่อรับคำแนะนำ</li>
                    </ol>
                {% endif %}
            </div>
            
            <div class="form-container">
                <form action="/" method="POST" id="mapForm">
                    <input type="hidden" name="polygon_coords" id="polygon_coords">
                    <button type="submit" id="analyzeBtn" disabled>วิเคราะห์พื้นที่</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
        // === 1. ส่วนกำหนดค่าแผนที่ (Map Initialization) ===
        const map = L.map('map').setView([13.75, 100.5], 6);

        // === 2. ส่วนกำหนดชั้นข้อมูลแผนที่ (Tile Layer Definitions) ===
        // แผนที่ปกติ (OpenStreetMap)
        const osmMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });
        
        // (ใหม่) แผนที่ความสูง (OpenTopoMap)
        const topoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
        });

        // กำหนดให้แผนที่ปกติเป็นค่าเริ่มต้น
        osmMap.addTo(map);

        // === 3. (ใหม่) ส่วนควบคุมการสลับชั้นข้อมูล (Layer Control) ===
        const baseMaps = {
            "แผนที่ปกติ": osmMap,
            "แผนที่ความสูง": topoMap
        };
        L.control.layers(baseMaps).addTo(map);

        // === 4. ส่วนควบคุมการวาด (Draw Control) ===
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        const drawControl = new L.Control.Draw({
            draw: { polygon: true, rectangle: true, polyline: false, circle: false, marker: false, circlemarker: false },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);
        
        const analyzeBtn = document.getElementById('analyzeBtn');
        const coordsInput = document.getElementById('polygon_coords');

        map.on(L.Draw.Event.CREATED, function (event) {
            const layer = event.layer;
            drawnItems.clearLayers();
            drawnItems.addLayer(layer);
            const geoJSON = layer.toGeoJSON();
            coordsInput.value = JSON.stringify(geoJSON);
            analyzeBtn.disabled = false;
        });
        
        map.on('draw:edited', function (e) {
            e.layers.eachLayer(function (layer) {
                const geoJSON = layer.toGeoJSON();
                coordsInput.value = JSON.stringify(geoJSON);
            });
        });
        
        // === 5. (ใหม่) ส่วนจำลองการคลิกเพื่อดูค่าความสูง (Click for Elevation Simulation) ===
        map.on('click', function(e) {
            // สุ่มค่าความสูงระหว่าง 10 ถึง 500 เมตร
            const randomElevation = (10 + Math.random() * 500).toFixed(2);
            const lat = e.latlng.lat.toFixed(5);
            const lng = e.latlng.lng.toFixed(5);

            const popupContent = `
                <b>ตำแหน่ง:</b> ${lat}, ${lng}<br>
                <b>ความสูง (จำลอง):</b> ${randomElevation} เมตร
            `;

            // แสดง Popup ณ จุดที่คลิก
            L.popup()
                .setLatLng(e.latlng)
                .setContent(popupContent)
                .openOn(map);
        });

        // === 6. ส่วนควบคุมการแสดงผล Panel (เหมือนเดิม) ===
        const resultsPanel = document.getElementById('resultsPanel');
        let isPanelOpened = false;
        const hasRecommendations = {{ has_recommendations|tojson }};
        if (hasRecommendations) {
            resultsPanel.classList.add('open');
            isPanelOpened = true;
        }
        map.on('dragstart', function() {
            if (!isPanelOpened) {
                resultsPanel.classList.add('open');
                isPanelOpened = true; 
            }
        });
    </script>
</body>
</html>