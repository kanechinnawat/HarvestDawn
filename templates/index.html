<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Harvest Dawn - Elevation Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body { font-family: 'Sarabun', sans-serif; background: #f4f7f6; color:#333; margin:0; overflow:hidden; }
    .container { display:flex; flex-direction:column; height:100vh; }
    .main-content { display:flex; flex:1; position:relative; }
    .map-container { flex:1; height:100%; }
    #map { width:100%; height:100%; }
    .results-panel { position:absolute; right:0; top:0; height:100%; width:480px; background:#fff; padding:20px; box-sizing:border-box; overflow-y:auto; box-shadow:-4px 0 8px rgba(0,0,0,.1); transition:.4s; transform:translateX(100%); z-index:1000; }
    .results-panel.open { transform:translateX(0); }
    .form-container { position:absolute; top:20px; left:50%; transform:translateX(-50%); z-index:1001; background:#fff; padding:14px; border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,.15);}
    button { padding:10px 14px; background:#4CAF50; color:#fff; border:0; border-radius:6px; cursor:pointer; }
    button[disabled] { background:#bbb; cursor:not-allowed; }
    h2,h3 { color:#2c5d3c; }
    .info-box { background:#e9f5e9; padding:14px; border-radius:6px; margin-bottom:16px; display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .result-card { border:1px solid #e5e7eb; border-left:5px solid #4CAF50; padding:14px; margin-bottom:14px; border-radius:6px; background:#fafafa; }
    .result-card.low-score { border-left-color:#f4b400; }
    .advice { color:#0f5132; background:#d1e7dd; padding:8px 10px; border-radius:6px; margin-top:8px; font-size:.95em; }
    .reasons { color:#b02a37; font-size:.9em; margin-top:6px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <div class="map-container"><div id="map"></div></div>

      <div class="results-panel" id="resultsPanel">
        {% if recommendations %}
          <h2>ผลการวิเคราะห์</h2>
          <div class="info-box">
            <div><strong>ชนิดดิน:</strong> {{ input_data.soil_type }}</div>
            <div><strong>ฝน:</strong> {{ "%.0f"|format(input_data.avg_rainfall_mm) }} มม.</div>
            <div><strong>อุณหภูมิ:</strong> {{ "%.0f"|format(input_data.avg_temp_celsius) }} °C</div>
            <div><strong>ลาดชัน:</strong> {{ "%.0f"|format(input_data.slope_degree) }}°</div>
          </div>

          {% for rec in recommendations %}
          <div class="result-card {% if rec.suitability_score < 3 %}low-score{% endif %}">
            <h3>{{ loop.index }}. {{ rec.crop_name }}</h3>
            <p><strong>คะแนน:</strong> {{ rec.suitability_score }} / {{ rec.max_score }}</p>
            <p><strong>แนวโน้มราคา:</strong> {{ rec.market_trend }}</p>

            {% if rec.advice %}
              <div class="advice"><strong>คำแนะนำเพิ่มเติม:</strong> {{ rec.advice }}</div>
            {% endif %}

            {% if rec.reasons_for_low_score %}
              <p class="reasons"><strong>ข้อควรพิจารณา:</strong> {{ rec.reasons_for_low_score | join(', ') }}</p>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <h3>ยินดีต้อนรับสู่ Harvest Dawn</h3>
          <p>1) วาดขอบเขตพื้นที่บนแผนที่</p>
          <p>2) กด “วิเคราะห์พื้นที่” เพื่อดูผลลัพธ์</p>
        {% endif %}
      </div>

      <div class="form-container">
        <form action="/" method="POST" id="mapForm">
          <input type="hidden" name="polygon_coords" id="polygon_coords">
          <button type="submit" id="analyzeBtn" disabled>วิเคราะห์พื้นที่</button>
        </form>
      </div>
    </div>
  </div>

  <!-- ฝังค่า has_recommendations เป็น JSON แยกต่างหาก -->
  <script id="hasRecsData" type="application/json">{{ has_recommendations | tojson }}</script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script>
    const map = L.map('map').setView([13.75, 100.5], 6);
    const osm  = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png');
    L.control.layers({ "แผนที่ปกติ": osm, "แผนที่ภูมิประเทศ": topo }).addTo(map);

    const drawn = new L.FeatureGroup().addTo(map);
    new L.Control.Draw({
      draw: { polygon:true, rectangle:true, marker:false, circle:false, circlemarker:false, polyline:false },
      edit: { featureGroup: drawn }
    }).addTo(map);

    const analyzeBtn  = document.getElementById('analyzeBtn');
    const coordsInput = document.getElementById('polygon_coords');
    map.on(L.Draw.Event.CREATED, e => {
      drawn.clearLayers();
      drawn.addLayer(e.layer);
      coordsInput.value = JSON.stringify(e.layer.toGeoJSON());
      analyzeBtn.disabled = false;
    });

    const resultsPanel = document.getElementById('resultsPanel');
    const hasRecommendations = JSON.parse(document.getElementById('hasRecsData').textContent || 'false');
    if (hasRecommendations) resultsPanel.classList.add('open');
  </script>
</body>
</html>
